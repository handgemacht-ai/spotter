FROM hexpm/elixir:1.19.2-erlang-27.3.4-debian-bookworm-20260202

ENV MIX_ENV=dev \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    TZ=UTC

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    build-essential \
    curl \
    file \
    git \
    jq \
    tmux \
  && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
  && apt-get install -y --no-install-recommends nodejs \
  && rm -rf /var/lib/apt/lists/*

RUN npm install -g @anthropic-ai/claude-code

WORKDIR /app

RUN mix local.hex --force && mix local.rebar --force

COPY mix.exs mix.lock ./
COPY config config
COPY vendor/claude_agent_sdk/mix.exs vendor/claude_agent_sdk/mix.exs
RUN mix deps.get

COPY assets/package.json assets/package-lock.json ./assets/
RUN npm ci --prefix assets

COPY . .
RUN mix compile

# Build frontend assets and verify output
RUN node assets/build.js && \
    test -s priv/static/assets/app.js || \
    (echo "ERROR: priv/static/assets/app.js missing or empty after build" >&2 && exit 1)

# Copy plugin into a well-known path
COPY spotter-plugin /opt/spotter-plugin

# Create world-writable dirs so arbitrary uid can write
RUN mkdir -p /home/spotter /var/lib/spotter && \
    chmod 0777 /home/spotter /var/lib/spotter

ENTRYPOINT ["scripts/docker/spotter_live_entrypoint.sh"]
