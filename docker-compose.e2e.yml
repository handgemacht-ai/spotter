services:
  spotter:
    build:
      context: .
      dockerfile: Dockerfile.e2e
    environment:
      MIX_ENV: dev
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:?ANTHROPIC_API_KEY is required}
      SPOTTER_E2E_FIXTURE_ROOT: /app/test/fixtures/transcripts
      TZ: UTC
      LANG: C.UTF-8
      LC_ALL: C.UTF-8
    ports:
      - "1100:1100"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:1100/ > /dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 40
      start_period: 20s
    command: ["bash", "-lc", "scripts/e2e/start_spotter.sh"]

  playwright:
    image: mcr.microsoft.com/playwright:v1.56.1-noble
    working_dir: /work
    volumes:
      - ./:/work
    depends_on:
      spotter:
        condition: service_healthy
    environment:
      SPOTTER_BASE_URL: http://spotter:1100
      TZ: UTC
      LANG: C.UTF-8
      LC_ALL: C.UTF-8
    command: ["bash", "-lc", "cd e2e && npm ci && npx playwright test --update-snapshots=missing"]
